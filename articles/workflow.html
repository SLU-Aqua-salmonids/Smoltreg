<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Smoltreg workflow • Smoltreg</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="workflow_files/libs/quarto-html/popper.min.js"></script><script src="workflow_files/libs/quarto-html/tippy.umd.min.js"></script><link href="workflow_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="workflow_files/libs/quarto-html/light-border.css" rel="stylesheet">
<script src="workflow_files/libs/quarto-diagram/mermaid.min.js"></script><script src="workflow_files/libs/quarto-diagram/mermaid-init.js"></script><link href="workflow_files/libs/quarto-diagram/mermaid.css" rel="stylesheet">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Smoltreg workflow">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">Smoltreg</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/workflow.html">Smoltreg workflow</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-quarto">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Smoltreg workflow</h1>


      <p class="date">2024-11-05</p>


      <div class="d-none name"><code></code></div>
    </div>






    <section class="level2"><h2 id="workflow-overview">Workflow overview<a class="anchor" aria-label="anchor" href="#workflow-overview"></a>
</h2>
<p>To assist in the quality assurance of smolt data (used for mark/recapture studies and more) several R-packages are available. This vignette in package <em>Smoltreg</em> gives an overview of the whole process from delivery of raw data from the traps to a human readable report with assesment of smolt production for a river.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install our inhouse packages used</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"SLU-Aqua-diadromous/Smoltreg"</span>, build_vignettes <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"SLU-Aqua-diadromous/smolts2bugs"</span>, build_vignettes <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"SLU-Aqua-diadromous/SmoltReports"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="cell" data-fig-width="7" data-layout-align="default">
<div class="cell-output-display">
<div id="fig-workflow" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-fig"><div aria-describedby="fig-workflow-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>
<pre class="mermaid mermaid-js" data-label="fig-workflow">flowchart TD
  A[Archive received data on restricted/Lax/Data/YYYY/Rådata/River/... \nRegister the data in restricted/Lax/Data/Loggbok_Datahantering_Lax.xlsx]
  B[Make a private copy for quality check and prepatation for Sötebasen \nCheck and fix the data when data is OK prepare a Sötebasen file. \nTool to check data and format Sötebasen file at github.com/SLU-Aqua-diadromous/Smoltreg \nMail Sötebasen-file to Ålderslabb]
  C[When the data is imported in Sötebasen it will be available at: \nrestricted/Sötebasen/Exporter/Smoltfälla*.csv]
  D[Use package smolt2bugs to reformat Sötebasen export to an Blackbox/Excel-file\nCut and Paste result into Blackbox]
  E[Create report using SmoltReports]
  A --&gt; B
  B --&gt; C
  C --&gt; D
  D --&gt; E
</pre>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-workflow-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure 1: Overview of workflow for smolt traps data collection
</figcaption></figure>
</div>
</div>
</div>
<ol type="1">
<li>Data arrives to dcfdata@slu.se:
<ul>
<li>Save data in $restricted/Lax/Data/YYYY/Rådata/River/Smoltfälla</li>
<li>Copy the data files to a personal work folder</li>
</ul>
</li>
<li>Start Smoltreg::smoltregApp()
<ul>
<li>Load Smoltreg Excel file</li>
<li>Check data</li>
<li>Fix errors</li>
<li>Repeat until clean</li>
<li>Save Sötebasen file</li>
</ul>
</li>
<li>Mail Sötebasen file to Ålderslabb (Malin)</li>
<li>Create BlackBox input (<a href="https://github.com/SLU-Aqua-diadromous/smolts2bugs" class="external-link uri">https://github.com/SLU-Aqua-diadromous/smolts2bugs</a>)
<ul>
<li>Use <em>sote2bugs.R</em> to convert data with <em>$restricted/Sötebasen/Exporter/</em> as input</li>
<li>Use <em>sote_import2bugs.R</em> to convert the file we send to Ålderslabb as input</li>
</ul>
</li>
<li>Run model in <em>BlackBox</em>
<ul>
<li>Start BlackBox (see also original documentation from Atso and Stefan<a class="footnote-ref" role="doc-noteref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;&lt;em&gt;Introduction to smolt model and Blackbox_Stefan P. Dec 2010_updated Feb 6 2017.docx&lt;/em&gt; installed in inst/BlackBox/doc&lt;/p&gt;"><sup>1</sup></a>)</li>
<li>Cut and paste data from the Excel file produced by <em>smolts2bugs</em> into the various <em>.odc</em> files.</li>
<li>Run the model and save the results (Described below and in the original documentation)</li>
</ul>
</li>
<li>Use <a href="https://slu-aqua-diadromous.github.io/SmoltReports/" class="external-link uri">https://slu-aqua-diadromous.github.io/SmoltReports/</a> to produce report</li>
</ol></section><section class="level2"><h2 id="dataflow-from-smoltreg-to-sötebasen">Dataflow from Smoltreg to Sötebasen<a class="anchor" aria-label="anchor" href="#dataflow-from-smoltreg-to-s%C3%B6tebasen"></a>
</h2>
<p>This section describes the parts 1 to 3 of the workflow in more detail.</p>
<p>Data from the smolt traps are delivered in a Excel-file with a predefined format. Usually this file is named <em>Smoltreg_RIVER_YYYY_MM_DD.xlsx</em>. The file should contain the tabs:</p>
<ol type="1">
<li>
<em>Fiskdata</em> with data for the individual catches.</li>
<li>
<em>Metadata</em> Basic data about the location and active period of the trap.</li>
<li>
<em>Metadata2</em> Data needed by Sötebasen</li>
<li>
<em>Dagbok</em> (Optional) Daily logg with information of significant efents. Can also contain maually registered water temp and water flow.</li>
<li>
<em>Envlogger_water</em> Data from data logger (added by SLU see below)</li>
<li>
<em>Envlogger_land</em> Data from data logger (added by SLU see below)</li>
</ol>
<p>In addition there should be two file from the temp/pressure loggers with the file extension <em>.hobo</em>. This data must be quality checked for errors and formatted into a format suitable for importing info <em>Sötebasen</em>. The formatted file is sent to <em>Ålderslabb</em> that will add additional data before the file is sent <em>Anders Kinnerbäck</em> to be imported into <em>Sötebasen</em>.</p>
<p>All data from smolt traps are exported from Sötebasen into <em>\\storage-dh.slu.se\restricted$\Sötebasen\Exporter\Smoltfälla*.csv</em>. These .csv-files are later used as input for estimation of the total smolt runs.</p>
<p>Package <em>Smoltreg</em> contains routines and a shiny-app that will facilitate the error checking and finally format a file ready to be sent to ålderslab</p>
<section class="level3"><h3 id="workflow">Workflow<a class="anchor" aria-label="anchor" href="#workflow"></a>
</h3>
<p>Make copies of the delivered data files for a smolt trap. You will find the raw (as delivered) data files on the central file server <em>\\storage-dh.slu.se\restricted$\Lax\Data\YYYY\Rådata\RIVER</em> (where <em>YYYY</em> and <em>RIVER</em> should be changed). You should have at least an Excel file with fishdata and an file from the temp-pressure logger.</p>
<p>You must then compile one single Excel that contains several tabs with specific tabs for fishdata, environmental data (temp and water level) and metadata.</p>
<ol type="1">
<li>Open your copy of the Excel file and make an initial check of the tab <em>Fiskdata</em>. The tab <em>Fiskdata</em> should be a list of fish observations.</li>
<li>Do a quick scan of the data to find obvious error. For example check that the same date format, the prefered data format is <em>YY-MM-DD HH:MM</em>. Obvious errors should be fixed before you try to run the data checking script.</li>
<li>Switch to tab <em>Metadata</em> and check that it is filled by the trap personel, otherwise fill it yourself (<em>Dummy tag:</em> is optional).</li>
<li>Create a new tab named <em>Metadata2</em>. This tab contains fields that are required for the Sötebasen-import. Needed fields are: Metod, Beställare, Ansvarig, Syfte, Sekretess, Märkning and Signatur. See an example from previous year for an example.</li>
</ol></section><section class="level3"><h3 id="adding-loggerdata">Adding loggerdata<a class="anchor" aria-label="anchor" href="#adding-loggerdata"></a>
</h3>
<section class="level4"><h4 id="alt-1--you-have-data-from-hobo-loggers-">Alt 1. You have data from HOBO loggers.<a class="anchor" aria-label="anchor" href="#alt-1--you-have-data-from-hobo-loggers-"></a>
</h4>
<ol type="1">
<li>Use HOBOware to convert the hobo data files to excel-files. One file from logger in the water and one from logger in the air. Make sure that to use SI-units (kPa and °C), only export data and no events.</li>
<li>Add each file to a tab in the file. Name the tabs <em>Envlogger_water</em> and <em>Envlogger_land</em>.</li>
</ol>
<p>The app will trim the data to include dates between start and stop date (defined in tab Metadata), calculate water depth from the preassure and calculate mean temp and depth for each day.</p>
</section><section class="level4"><h4 id="alt-2--you-have-manually-measured-temp-and-level">Alt 2. You have manually measured temp and level<a class="anchor" aria-label="anchor" href="#alt-2--you-have-manually-measured-temp-and-level"></a>
</h4>
<p>If data from loggers for some reason isn’t available you can use data recorded maually or downloaded from the net.</p>
<ol type="1">
<li>Add a sheet named <em>Miljödata</em> with three columns <em>date</em>, <em>w_level</em> and <em>w_temp</em>.</li>
<li>Add your values to the <em>Miljödata</em> sheet. One row per date for the period the trap was active.</li>
</ol></section></section><section class="level3"><h3 id="running-the-smoltreg-app">Running the Smoltreg app<a class="anchor" aria-label="anchor" href="#running-the-smoltreg-app"></a>
</h3>
<p><em>Smoltreg::smoltregApp()</em> is a shiny-app that facilitates quality assurance of the input file and formatting of a output file in the format required by <em>Sötebasen</em>. The app will automatically fix some errors, for example fix case of species names.</p>
<ol type="1">
<li>Start the shiny app to sanity checks on the <em>Smoltreg</em>-file with the command <em>Smoltreg::smoltregApp()</em>.</li>
<li>Check your file by clicking on the various buttons from top to bottom. Often errors are dependent on each other so start topmost test and fix errors as you go.</li>
<li>Everytime you make changes reload the file and check evrything until all errors are eliminated.</li>
<li>Finally the button “Save Sötebasen-file” can save a file suitable to import into Sötebasen.</li>
</ol></section></section><section class="level2"><h2 id="flowchart">Flowchart<a class="anchor" aria-label="anchor" href="#flowchart"></a>
</h2>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div id="fig-flowchart" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-fig"><div aria-describedby="fig-flowchart-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>
<pre class="mermaid mermaid-js" data-label="fig-flowchart">flowchart TD
    A[Smoltreg.xlsx] --&gt; B(smoltregApp)
    B --&gt; C{All test OK}
    C --&gt;|No| D[Fix error] --&gt; B
    C --&gt;|Yes| E[Save Sötebasen-file]
    E --&gt; F[Send to Ålderslabb]
</pre>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-flowchart-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure 2: Workflow to qualitycheck the incomming smolt data
</figcaption></figure>
</div>
</div>
</div>
</section><section class="level2"><h2 id="save-blackbox-data">Save <code>BlackBox</code> data<a class="anchor" aria-label="anchor" href="#save-blackbox-data"></a>
</h2>
<p>Open <code>Samples...</code> in the <code>Inference</code> menue in <code>BlackBox</code>. Set <code>chains</code> to 1 to 2, <code>beg</code> to 5000, <code>end</code> to 25 000 and <code>thin</code> to 20. This will extract 1000 samples from each chain for a total of 2000 samples.</p>
<p>First extract summary statistics for all variables by setting <code>node</code> to * and click <code>stats</code>. Select all data in the <code>Node statistics</code> window and paste it into Excel. If Column A is blank delete it. Rename the sheet to <code>stats</code> and save the file as <code>model_results.xlsx</code> in the <code>SMOLTS_river_year/species</code> folder.</p>
<p>Change <code>node</code> to <code>CU</code> and click <code>coda</code>. Three windows will open but you can close the one called <code>CODA index</code>. Create a new sheet in the <code>model_results.xlsx</code> spread sheet and rename it to <code>CU</code>. Select everything in the window <code>CODA for chain 1</code>, copy and paste to the <code>CU</code> sheet (columns A and B). Repeat for window <code>CODA for chain 2</code> but copy into columns C and D. Remove the (duplicated) column C. Insert a row at the top and set column names to <code>iteration</code>, <code>chain1</code> and <code>chain2</code>. Repeat the above steps for node <code>sigma</code> and save the Excel file.</p>
<p>Create a Word-file named <code>gelman_rubin.docx</code> in the <code>SMOLTS_river_year/species</code> folder and cut and paste the two windows named <code>Gelman Rubin statistic</code>.</p>
</section><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'light-border',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config);
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script></main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Anders Kagervall.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
